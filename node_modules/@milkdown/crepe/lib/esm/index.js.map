{"version":3,"file":"index.js","sources":["../../src/feature/index.ts","../../src/core/slice.ts","../../src/core/crepe.ts"],"sourcesContent":["import type { Editor } from '@milkdown/kit/core'\nimport type { PlaceHolderFeatureConfig } from './placeholder'\nimport type { CodeMirrorFeatureConfig } from './code-mirror'\nimport type { BlockEditFeatureConfig } from './block-edit'\nimport type { CursorFeatureConfig } from './cursor'\nimport type { ImageBlockFeatureConfig } from './image-block'\nimport type { LinkTooltipFeatureConfig } from './link-tooltip'\nimport type { ListItemFeatureConfig } from './list-item'\nimport type { ToolbarFeatureConfig } from './toolbar'\nimport type { TableFeatureConfig } from './table'\n\nexport enum CrepeFeature {\n  CodeMirror = 'code-mirror',\n  ListItem = 'list-item',\n  LinkTooltip = 'link-tooltip',\n  Cursor = 'cursor',\n  ImageBlock = 'image-block',\n  BlockEdit = 'block-edit',\n  Toolbar = 'toolbar',\n  Placeholder = 'placeholder',\n  Table = 'table',\n}\n\nexport interface CrepeFeatureConfig {\n  [CrepeFeature.Cursor]?: CursorFeatureConfig\n  [CrepeFeature.ListItem]?: ListItemFeatureConfig\n  [CrepeFeature.LinkTooltip]?: LinkTooltipFeatureConfig\n  [CrepeFeature.ImageBlock]?: ImageBlockFeatureConfig\n  [CrepeFeature.BlockEdit]?: BlockEditFeatureConfig\n  [CrepeFeature.Placeholder]?: PlaceHolderFeatureConfig\n  [CrepeFeature.Toolbar]?: ToolbarFeatureConfig\n  [CrepeFeature.CodeMirror]?: CodeMirrorFeatureConfig\n  [CrepeFeature.Table]?: TableFeatureConfig\n}\n\nexport const defaultFeatures: Record<CrepeFeature, boolean> = {\n  [CrepeFeature.Cursor]: true,\n  [CrepeFeature.ListItem]: true,\n  [CrepeFeature.LinkTooltip]: true,\n  [CrepeFeature.ImageBlock]: true,\n  [CrepeFeature.BlockEdit]: true,\n  [CrepeFeature.Placeholder]: true,\n  [CrepeFeature.Toolbar]: true,\n  [CrepeFeature.CodeMirror]: true,\n  [CrepeFeature.Table]: true,\n}\n\nexport async function loadFeature(feature: CrepeFeature, editor: Editor, config?: never) {\n  switch (feature) {\n    case CrepeFeature.CodeMirror: {\n      const { defineFeature } = await import('./code-mirror')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.ListItem: {\n      const { defineFeature } = await import('./list-item')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.LinkTooltip: {\n      const { defineFeature } = await import('./link-tooltip')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.ImageBlock: {\n      const { defineFeature } = await import('./image-block')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.Cursor: {\n      const { defineFeature } = await import('./cursor')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.BlockEdit: {\n      const { defineFeature } = await import('./block-edit')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.Placeholder: {\n      const { defineFeature } = await import('./placeholder')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.Toolbar: {\n      const { defineFeature } = await import('./toolbar')\n      return defineFeature(editor, config)\n    }\n    case CrepeFeature.Table: {\n      const { defineFeature } = await import('./table')\n      return defineFeature(editor, config)\n    }\n  }\n}\n","import type { Ctx } from '@milkdown/kit/ctx'\nimport { createSlice } from '@milkdown/kit/ctx'\nimport type { CrepeFeature } from '../feature'\n\nexport const FeaturesCtx = createSlice([] as CrepeFeature[], 'FeaturesCtx')\n\nexport function configureFeatures(features: CrepeFeature[]) {\n  return (ctx: Ctx) => {\n    ctx.inject(FeaturesCtx, features)\n  }\n}\n","import type { DefaultValue } from '@milkdown/kit/core'\nimport { Editor, defaultValueCtx, editorViewOptionsCtx, rootCtx } from '@milkdown/kit/core'\n\nimport { commonmark } from '@milkdown/kit/preset/commonmark'\nimport { gfm } from '@milkdown/kit/preset/gfm'\nimport { history } from '@milkdown/kit/plugin/history'\nimport { indent, indentConfig } from '@milkdown/kit/plugin/indent'\nimport { getMarkdown } from '@milkdown/kit/utils'\nimport { clipboard } from '@milkdown/kit/plugin/clipboard'\nimport { trailing } from '@milkdown/kit/plugin/trailing'\n\nimport type { CrepeFeatureConfig } from '../feature'\nimport { CrepeFeature, defaultFeatures, loadFeature } from '../feature'\nimport { configureFeatures } from './slice'\n\nexport interface CrepeConfig {\n  features?: Partial<Record<CrepeFeature, boolean>>\n  featureConfigs?: CrepeFeatureConfig\n  root?: Node | string | null\n  defaultValue?: DefaultValue\n}\n\nexport class Crepe {\n  static Feature = CrepeFeature\n  readonly #editor: Editor\n  readonly #initPromise: Promise<unknown>\n  readonly #rootElement: Node\n  #editable = true\n\n  constructor({\n    root,\n    features = {},\n    featureConfigs = {},\n    defaultValue = '',\n  }: CrepeConfig) {\n    const enabledFeatures = Object\n      .entries({\n        ...defaultFeatures,\n        ...features,\n      })\n      .filter(([, enabled]) => enabled)\n      .map(([feature]) => feature as CrepeFeature)\n\n    this.#rootElement = (typeof root === 'string' ? document.querySelector(root) : root) ?? document.body\n    this.#editor = Editor.make()\n      .config(configureFeatures(enabledFeatures))\n      .config((ctx) => {\n        ctx.set(rootCtx, this.#rootElement)\n        ctx.set(defaultValueCtx, defaultValue)\n        ctx.set(editorViewOptionsCtx, {\n          editable: () => this.#editable,\n        })\n        ctx.update(indentConfig.key, value => ({\n          ...value,\n          size: 4,\n        }))\n      })\n      .use(commonmark)\n      .use(history)\n      .use(indent)\n      .use(trailing)\n      .use(clipboard)\n      .use(gfm)\n\n    const promiseList: Promise<unknown>[] = []\n\n    enabledFeatures.forEach((feature) => {\n      const config = (featureConfigs as Partial<Record<CrepeFeature, never>>)[feature]\n      promiseList.push(\n        loadFeature(feature, this.#editor, config),\n      )\n    })\n\n    this.#initPromise = Promise.all(promiseList)\n  }\n\n  async create() {\n    await this.#initPromise\n    return this.#editor.create()\n  }\n\n  async destroy() {\n    await this.#initPromise\n    return this.#editor.destroy()\n  }\n\n  get editor(): Editor {\n    return this.#editor\n  }\n\n  setReadonly(value: boolean) {\n    this.#editable = !value\n    return this\n  }\n\n  getMarkdown() {\n    return this.#editor.action(getMarkdown())\n  }\n}\n"],"names":["CrepeFeature"],"mappings":"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"}